{"ast":null,"code":"'use strict';\n\nvar Buffer = require('safe-buffer').Buffer;\n\nvar utils = require('../utils');\n\nvar StripeResource = require('../StripeResource');\n\nvar stripeMethod = StripeResource.method;\n\nvar multipartDataGenerator = require('../MultipartDataGenerator');\n\nvar Error = require('../Error');\n\nmodule.exports = StripeResource.extend({\n  requestDataProcessor: function requestDataProcessor(method, data, headers, callback) {\n    data = data || {};\n\n    if (method === 'POST') {\n      return getProcessorForSourceType(data);\n    } else {\n      return callback(null, utils.stringifyRequestData(data));\n    }\n\n    function getProcessorForSourceType(data) {\n      var isStream = utils.checkForStream(data);\n\n      if (isStream) {\n        return streamProcessor(multipartDataGenerator);\n      } else {\n        var buffer = multipartDataGenerator(method, data, headers);\n        return callback(null, buffer);\n      }\n    }\n\n    function streamProcessor(fn) {\n      var bufferArray = [];\n      data.file.data.on('data', function (line) {\n        bufferArray.push(line);\n      }).on('end', function () {\n        var bufferData = Object.assign({}, data);\n        bufferData.file.data = Buffer.concat(bufferArray);\n        var buffer = fn(method, bufferData, headers);\n        callback(null, buffer);\n      }).on('error', function (err) {\n        var errorHandler = streamError(callback);\n        errorHandler(err);\n      });\n    }\n\n    function streamError(callback) {\n      var StreamProcessingError = Error.extend({\n        type: 'StreamProcessingError',\n        populate: function populate(raw) {\n          this.type = this.type;\n          this.message = raw.message;\n          this.detail = raw.detail;\n        }\n      });\n      return function (error) {\n        callback(new StreamProcessingError({\n          message: 'An error occurred while attempting to process the file for upload.',\n          detail: error\n        }), null);\n      };\n    }\n  },\n  path: 'files',\n  includeBasic: ['list', 'retrieve'],\n  create: stripeMethod({\n    method: 'POST',\n    headers: {\n      'Content-Type': 'multipart/form-data'\n    },\n    host: 'files.stripe.com'\n  })\n});","map":null,"metadata":{},"sourceType":"script"}